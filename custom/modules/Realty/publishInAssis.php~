<?php
class Assis
{
    
    function send_assis_request(SugarBean $bean, $event, $arguments)
    {  
        global $sugar_config;
        //коннектимся к контроллеру
        if ((isset($_SESSION['assis_sign_in'])) &&
            ($_SESSION['assis_sign_in'] == 'OK') && 
                ($bean->publich_assis_c == 1)) {
            
            $db = DBManagerFactory::GetInstance();
            
            $query = "SELECT assis_id_c FROM realty_cstm WHERE id_c='{$bean->id}'";
            $resource = $db->query($query);
            
            $assis_id = mysqli_fetch_object($resource)->assis_id_c;
            if ($assis_id == NULL) {
                //объект новый
            } else {
                //                старый объект
                //                
                $data = array('assis_id' => $assis_id);
                $data = http_build_query($data);
                $url = "{$sugar_config['site_url']}/index.php?module=ModuleBuilder";
                
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, "index.php?module=Realty&action=updateAssisObj&to_pdf=1");
//                curl_setopt($ch, CURLOPT_POST, 1);
//                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                $server_output = curl_exec($ch);
                curl_close($ch);
                echo "url: $url<br>";
                echo 'data: '.$data;
                echo '<br>';
                echo 'server_output: ';
                print_r($server_output);
                
//                $homepage = file_get_contents($url);
//                print_r($homepage);














//
// test HTTP POST submitter, using “libcurl”
//
// the target URL which contains scripts that accepts post request
$url = "index.php?module=Realty&action=updateAssisObj&to_pdf=1";
$ch = curl_init();
// set the target url
curl_setopt($ch, CURLOPT_URL,$url);
// howmany parameter to post
curl_setopt($ch, CURLOPT_POST, 1);
; 
// allow redirects 

// HERE YOU MUST SET THE VARIABLES FROM THE FORM
curl_setopt($ch, CURLOPT_POSTFIELDS, $_POST);
// execute curl,fetch the result and close curl connection
$result= curl_exec ($ch);
curl_close ($ch);

//after finishing your job you may wish to check the parameters and result
 print_r($result);
 print_r($_POST);


                die;

            }
        }
    }
    
   
}
